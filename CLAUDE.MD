# CLAUDE.MD - Gu√≠a para Claude Code

Este documento proporciona contexto y gu√≠as para trabajar efectivamente con el proyecto BotMQL5.

## üìã Resumen del Proyecto

Sistema de trading automatizado dual (MQL5 + Python) para scalping en Forex con:
- **Expert Advisor (EA)** en MQL5 que ejecuta la estrategia de trading
- **Backend Python** para an√°lisis, dashboard y comunicaci√≥n bidireccional
- **Estrategia**: Multi-Timeframe Momentum Scalper (M1/M5/M15)
- **Comunicaci√≥n**: Archivos JSON compartidos entre MT5 y Python

## üèóÔ∏è Arquitectura del Sistema

### Componentes Principales

#### 1. MQL5 (MetaTrader 5)
```
MQL5/
‚îú‚îÄ‚îÄ Experts/
‚îÇ   ‚îî‚îÄ‚îÄ MultiTF_Scalper.mq5          # EA principal (punto de entrada)
‚îú‚îÄ‚îÄ Include/
‚îÇ   ‚îú‚îÄ‚îÄ Constants.mqh                 # Constantes globales y enums
‚îÇ   ‚îú‚îÄ‚îÄ RiskManager.mqh              # Gesti√≥n de riesgo y capital
‚îÇ   ‚îú‚îÄ‚îÄ SessionManager.mqh           # Control de sesiones de trading
‚îÇ   ‚îú‚îÄ‚îÄ TradeManager.mqh             # Ejecuci√≥n y gesti√≥n de trades
‚îÇ   ‚îú‚îÄ‚îÄ SignalEngine.mqh             # An√°lisis t√©cnico y se√±ales
‚îÇ   ‚îî‚îÄ‚îÄ SocketClient.mqh             # Comunicaci√≥n con Python
‚îî‚îÄ‚îÄ Libraries/
    ‚îî‚îÄ‚îÄ JsonParser.mqh               # Parsing JSON (si se necesita)
```

**Flujo de ejecuci√≥n MQL5:**
1. `OnInit()`: Inicializaci√≥n, configuraci√≥n, validaciones
2. `OnTick()`: An√°lisis de mercado, generaci√≥n de se√±ales, gesti√≥n de posiciones
3. `OnDeinit()`: Limpieza y cierre de recursos

#### 2. Python (Backend y Dashboard)
```
Python/
‚îú‚îÄ‚îÄ main.py                          # Entry point de la aplicaci√≥n
‚îú‚îÄ‚îÄ config.py                        # Configuraci√≥n centralizada
‚îú‚îÄ‚îÄ requirements.txt                 # Dependencias Python
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ risk_manager.py             # C√°lculos de riesgo
‚îÇ   ‚îú‚îÄ‚îÄ signal_analyzer.py          # An√°lisis de se√±ales
‚îÇ   ‚îî‚îÄ‚îÄ strategy_validator.py       # Validaci√≥n de estrategia
‚îú‚îÄ‚îÄ communication/
‚îÇ   ‚îú‚îÄ‚îÄ file_bridge.py              # Lectura/escritura de archivos JSON
‚îÇ   ‚îî‚îÄ‚îÄ command_handler.py          # Procesamiento de comandos
‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îú‚îÄ‚îÄ app.py                      # Aplicaci√≥n Dash
‚îÇ   ‚îú‚îÄ‚îÄ layouts.py                  # Layouts del dashboard
‚îÇ   ‚îî‚îÄ‚îÄ callbacks.py                # Callbacks interactivos
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ database.py                 # SQLite para hist√≥rico
‚îÇ   ‚îî‚îÄ‚îÄ models.py                   # Modelos de datos
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ logger.py                   # Logging centralizado
    ‚îî‚îÄ‚îÄ helpers.py                  # Funciones auxiliares
```

### Comunicaci√≥n MT5 ‚Üî Python

**Directorio de intercambio:**
```
%APPDATA%\MetaQuotes\Terminal\Common\Files\ScalpingBot\
```

**Archivos JSON:**
- `mt5_status.json`: Estado del EA ‚Üí Python (posiciones, balance, equity, etc.)
- `python_signals.json`: Se√±ales Python ‚Üí MT5 (confirmaci√≥n/invalidaci√≥n)
- `python_to_mt5.json`: Comandos Python ‚Üí MT5 (PAUSE, RESUME, CLOSE_ALL)
- `mt5_to_python.json`: Eventos MT5 ‚Üí Python (trades ejecutados)
- `heartbeat.json`: Latido de conexi√≥n (ambos direcciones)

**Protocolo:**
1. MT5 escribe estado cada tick en `mt5_status.json`
2. Python lee cada segundo y procesa
3. Python escribe comandos en `python_to_mt5.json`
4. MT5 lee comandos cada tick y ejecuta
5. Heartbeat cada 5 segundos para verificar conexi√≥n

## üéØ Estrategia de Trading

### L√≥gica Multi-Timeframe

**M15 (Tendencia Principal):**
- EMA 9 y EMA 21
- Determina direcci√≥n general del mercado
- Long si EMA9 > EMA21, Short si EMA9 < EMA21

**M5 (Confirmaci√≥n Intermedia):**
- EMA 9 y EMA 21
- RSI (14): Filtro de momentum (40-70 para long, 30-60 para short)
- VWAP: Nivel din√°mico de referencia

**M1 (Timing de Entrada):**
- Stochastic (5,3,3): Se√±al de entrada precisa
- ATR (14): Validaci√≥n de volatilidad m√≠nima

### Gesti√≥n de Riesgo

**Reglas cr√≠ticas:**
- **M√°ximo drawdown cuenta**: 10% (configurable)
- **M√°ximo drawdown diario**: 5% (configurable)
- **M√°ximo trades/d√≠a**: 10 (configurable)
- **Riesgo por trade**: 1% del balance (configurable)
- **Stop Loss**: 10-15 pips
- **Take Profit parcial**: R:R 1:2 (cierra 50% + move to BE)
- **Take Profit final**: R:R 1:3 (cierra el 50% restante)

### Sesiones de Trading

Solo opera durante:
- **Londres**: 08:00 - 12:00 (hora del servidor MT5)
- **Nueva York**: 13:00 - 17:00 (hora del servidor MT5)

### Filtro de Noticias

- Buffer de 45 minutos antes y despu√©s de noticias de alto impacto
- Consulta calendario econ√≥mico (ForexFactory o similar)
- Bloquea nuevas entradas durante ventana de noticias
- Puede cerrar posiciones abiertas si hay exposici√≥n cr√≠tica

## üíª Desarrollo y Modificaciones

### Modificar la Estrategia de Trading

**Cambiar indicadores o par√°metros:**
1. Editar `MQL5/Include/SignalEngine.mqh`
2. Modificar funciones `AnalyzeM15()`, `AnalyzeM5()`, `AnalyzeM1()`
3. Actualizar constantes en `Constants.mqh` si es necesario
4. Recompilar en MetaEditor (F7)
5. Reiniciar EA en MT5

**Agregar nuevo indicador:**
1. Declarar handle en `SignalEngine.mqh` (secci√≥n de variables)
2. Inicializar en constructor o funci√≥n de setup
3. Integrar lectura de valores en funciones de an√°lisis
4. Liberar handle en destructor

### Modificar Gesti√≥n de Riesgo

**Cambiar c√°lculo de lote o SL/TP:**
1. Editar `MQL5/Include/RiskManager.mqh`
2. Modificar funci√≥n `CalculateLotSize()` para lote
3. Modificar funci√≥n `CalculateStopLoss()` o `CalculateTakeProfit()` para SL/TP
4. Asegurar que se respetan los l√≠mites del s√≠mbolo (volumen m√≠nimo/m√°ximo)

### Agregar Nueva Funcionalidad al Dashboard

**A√±adir nuevo panel o gr√°fico:**
1. Crear layout en `Python/dashboard/layouts.py`
2. Agregar callback en `Python/dashboard/callbacks.py`
3. Actualizar funci√≥n principal en `Python/dashboard/app.py`
4. Asegurar que los datos necesarios est√°n en `mt5_status.json`

**Agregar nuevo comando desde dashboard:**
1. Crear bot√≥n/control en `layouts.py`
2. Crear callback en `callbacks.py` que escriba en `python_to_mt5.json`
3. Implementar handler en `MQL5/Include/SocketClient.mqh`
4. Agregar comando a lista de comandos v√°lidos

### Base de Datos

**Agregar nuevo campo a hist√≥rico:**
1. Modificar modelo en `Python/data/models.py`
2. Crear migraci√≥n de base de datos (si usa ORM) o alterar tabla manualmente
3. Actualizar funci√≥n de inserci√≥n en `database.py`
4. Actualizar lectura desde MT5 en `communication/file_bridge.py`

## üîß Convenciones de C√≥digo

### MQL5

**Nomenclatura:**
- Clases: `PascalCase` (ej: `TradeManager`, `RiskManager`)
- Funciones: `PascalCase` (ej: `CalculateLotSize()`, `OpenTrade()`)
- Variables globales: `g_camelCase` (ej: `g_tradeManager`, `g_lastTickTime`)
- Variables locales: `camelCase` (ej: `lotSize`, `stopLoss`)
- Constantes: `UPPER_SNAKE_CASE` (ej: `MAX_SLIPPAGE`, `DEFAULT_MAGIC`)
- Enums: `PascalCase` con prefijo (ej: `ENUM_SIGNAL_TYPE`)

**Estilo:**
- Indentaci√≥n: 3 espacios (est√°ndar MQL5)
- Llaves en nueva l√≠nea para funciones
- Comentarios: `//` para l√≠nea, `/* */` para bloque
- Siempre validar retornos de funciones cr√≠ticas

**Ejemplo:**
```mql5
class CTradeManager
  {
private:
   double            m_stopLoss;
   double            m_takeProfit;

public:
   bool              OpenTrade(ENUM_ORDER_TYPE orderType, double volume)
     {
      // Validaci√≥n de par√°metros
      if(volume <= 0)
        {
         Print("Error: Invalid volume");
         return false;
        }

      // L√≥gica de apertura
      // ...

      return true;
     }
  };
```

### Python

**Nomenclatura:**
- Clases: `PascalCase` (ej: `RiskManager`, `SignalAnalyzer`)
- Funciones: `snake_case` (ej: `calculate_lot_size()`, `process_signal()`)
- Variables: `snake_case` (ej: `lot_size`, `stop_loss`)
- Constantes: `UPPER_SNAKE_CASE` (ej: `MAX_RETRIES`, `DEFAULT_PORT`)
- Privadas: Prefijo `_` (ej: `_internal_method()`)

**Estilo:**
- Seguir PEP 8
- Indentaci√≥n: 4 espacios
- Imports: agrupados (stdlib, third-party, local)
- Docstrings: Google Style
- Type hints donde sea apropiado

**Ejemplo:**
```python
from typing import Optional, Dict
import json

class RiskManager:
    """Gestiona el riesgo y c√°lculo de tama√±o de posici√≥n.

    Attributes:
        max_risk_percent: Porcentaje m√°ximo de riesgo por trade
        account_balance: Balance actual de la cuenta
    """

    def __init__(self, max_risk_percent: float = 1.0):
        self.max_risk_percent = max_risk_percent
        self._account_balance = 0.0

    def calculate_position_size(
        self,
        stop_loss_pips: float,
        pip_value: float
    ) -> Optional[float]:
        """Calcula el tama√±o de posici√≥n basado en riesgo.

        Args:
            stop_loss_pips: Stop loss en pips
            pip_value: Valor de un pip

        Returns:
            Tama√±o de posici√≥n en lotes, o None si hay error
        """
        if stop_loss_pips <= 0 or pip_value <= 0:
            return None

        risk_amount = self._account_balance * (self.max_risk_percent / 100)
        position_size = risk_amount / (stop_loss_pips * pip_value)

        return position_size
```

## üêõ Debugging

### MQL5

**Logs:**
- Usar `Print()` para mensajes generales
- Usar `Comment()` para mostrar en gr√°fico
- Logs se guardan en: `Terminal\[ID]\MQL5\Logs\`

**Errores comunes:**
- `Trade context is busy`: Esperar un tick o usar retry logic
- `Invalid stops`: Verificar distancia m√≠nima del broker (SYMBOL_TRADE_STOPS_LEVEL)
- `Not enough money`: Reducir tama√±o de lote o verificar balance
- `Market closed`: Verificar horarios de trading del s√≠mbolo

### Python

**Logs:**
- Configurar logging en `utils/logger.py`
- Niveles: DEBUG para desarrollo, INFO para producci√≥n
- Logs rotativos para evitar archivos grandes

**Errores comunes:**
- `File not found`: Verificar ruta de archivos JSON (usar Path de pathlib)
- `JSON decode error`: Archivo corrupto o escritura incompleta (implementar retry)
- `Connection timeout`: MT5 no est√° escribiendo heartbeat (verificar que EA est√© corriendo)

## üìù Testing

### MQL5

**Strategy Tester:**
1. Ctrl+R para abrir Strategy Tester
2. Seleccionar EA, s√≠mbolo, periodo
3. Usar "Every tick" o "1 minute OHLC" seg√∫n necesidad
4. Revisar reporte: Profit Factor, Drawdown, Win Rate

**Optimizaci√≥n:**
- Usar optimizaci√≥n gen√©tica para par√°metros
- Validar en per√≠odo fuera de muestra (out-of-sample)
- Evitar over-fitting

### Python

**Unit tests:**
```bash
cd Python
pytest tests/ -v
pytest tests/test_risk_manager.py -v  # Test espec√≠fico
```

**Integraci√≥n:**
- Simular archivos JSON de MT5 para testing
- Usar mocking para dependencias externas
- Validar todos los comandos y respuestas

## üö® Consideraciones Importantes

### Seguridad

- **Nunca** commitear claves API o credenciales
- Usar variables de entorno para configuraci√≥n sensible
- Revisar `.gitignore` para excluir archivos de configuraci√≥n local

### Performance

**MQL5:**
- Minimizar c√°lculos en `OnTick()` (se ejecuta cada cambio de precio)
- Cachear valores de indicadores cuando sea posible
- Usar timers (`OnTimer()`) para tareas peri√≥dicas no cr√≠ticas

**Python:**
- Usar async/await para I/O bound operations
- Implementar rate limiting para archivos JSON
- Considerar usar base de datos para hist√≥rico grande

### Mantenimiento

- **Backups**: Respaldar configuraci√≥n y datos antes de cambios mayores
- **Versionado**: Usar semantic versioning (MAJOR.MINOR.PATCH)
- **Changelog**: Documentar cambios significativos
- **Code review**: Revisar cambios antes de desplegar en cuenta real

## üéì Recursos de Aprendizaje

### MQL5
- [Documentaci√≥n oficial MQL5](https://www.mql5.com/en/docs)
- [MQL5 Reference](https://www.mql5.com/en/docs/references)
- [Art√≠culos sobre estrategias](https://www.mql5.com/en/articles)

### Python
- [Dash Documentation](https://dash.plotly.com/)
- [SQLAlchemy Docs](https://docs.sqlalchemy.org/)
- [Python asyncio](https://docs.python.org/3/library/asyncio.html)

## üìû Contacto y Soporte

Para problemas o preguntas:
1. Revisar Issues existentes en GitHub
2. Crear nuevo Issue con detalles: versi√≥n, logs, pasos para reproducir
3. Proporcionar archivos de log relevantes

---

**√öltima actualizaci√≥n**: 2026-01-19
**Versi√≥n del proyecto**: 1.0.0
